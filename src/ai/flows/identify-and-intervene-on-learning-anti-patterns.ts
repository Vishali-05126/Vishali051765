'use server';

/**
 * @fileOverview Identifies personal learning anti-patterns and provides timely interventions.
 *
 * - identifyAndInterveneOnLearningAntiPatterns - A function that orchestrates the identification of learning anti-patterns and provides interventions.
 * - IdentifyAndInterveneOnLearningAntiPatternsInput - The input type for the identifyAndInterveneOnLearningAntiPatterns function.
 * - IdentifyAndInterveneOnLearningAntiPatternsOutput - The return type for the identifyAndInterveneOnLearningAntiPatterns function.
 */

import {ai} from '@/ai/genkit';
import {z} from 'genkit';

const IdentifyAndInterveneOnLearningAntiPatternsInputSchema = z.object({
  learningHistory: z
    .string()
    .describe(
      'A detailed history of the student’s learning activities, including time spent on different tasks, notes taken, examples completed, and any difficulties encountered.'
    ),
  currentActivity: z
    .string()
    .describe(
      'A description of the student’s current learning activity, including the topic, learning goals, and any specific instructions or prompts.'
    ),
});
export type IdentifyAndInterveneOnLearningAntiPatternsInput = z.infer<
  typeof IdentifyAndInterveneOnLearningAntiPatternsInputSchema
>;

const InterventionSchema = z.object({
  type: z
    .string()
    .describe(
      'The type of intervention (e.g., encouragement, reminder, suggestion, question).'
    ),
  message: z
    .string()
    .describe(
      'The specific message to deliver to the student to address the identified anti-pattern.'
    ),
});

const IdentifyAndInterveneOnLearningAntiPatternsOutputSchema = z.object({
  antiPatterns: z
    .array(z.string())
    .describe(
      'A list of the student’s identified learning anti-patterns (e.g., skipping examples, not taking notes, zoning out after 20 minutes).'
    ),
  intervention: InterventionSchema.describe(
    'A personalized intervention designed to address the identified anti-pattern and improve learning efficiency.'
  ),
});
export type IdentifyAndInterveneOnLearningAntiPatternsOutput = z.infer<
  typeof IdentifyAndInterveneOnLearningAntiPatternsOutputSchema
>;

async function identifyAndInterveneOnLearningAntiPatterns(
  input: IdentifyAndInterveneOnLearningAntiPatternsInput
): Promise<IdentifyAndInterveneOnLearningAntiPatternsOutput> {
  return identifyAndInterveneOnLearningAntiPatternsFlow(input);
}

const interventionTool = ai.defineTool({
  name: 'generateIntervention',
  description:
    'Generates a personalized intervention message based on the identified anti-pattern.',
  inputSchema: z.object({
    antiPattern: z.string().describe('The specific learning anti-pattern.'),
  }),
  outputSchema: InterventionSchema,
},
async input => {
  const {text} = await ai.generate({
    prompt: `Create a personalized intervention message to address the following anti-pattern: ${input.antiPattern}. The intervention should be encouraging and specific.`, model: 'googleai/gemini-2.5-flash',
  });

  return {
    type: 'suggestion',
    message: text,
  };
});

const identifyAndInterveneOnLearningAntiPatternsPrompt = ai.definePrompt({
  name: 'identifyAndInterveneOnLearningAntiPatternsPrompt',
  input: {schema: IdentifyAndInterveneOnLearningAntiPatternsInputSchema},
  output: {schema: IdentifyAndInterveneOnLearningAntiPatternsOutputSchema},
  tools: [interventionTool],
  prompt: `You are an AI learning assistant. Analyze the student's learning history and current activity to identify any recurring anti-patterns that hinder their learning efficiency.  Based on the identified anti-patterns, use the generateIntervention tool to create personalized intervention messages to help the student overcome these bad habits.

  Learning History: {{{learningHistory}}}
  Current Activity: {{{currentActivity}}}

  First, list the anti-patterns you have identified.
  Then, use the generateIntervention tool to create an intervention for the most critical anti-pattern.
  `,
});

const identifyAndInterveneOnLearningAntiPatternsFlow = ai.defineFlow(
  {
    name: 'identifyAndInterveneOnLearningAntiPatternsFlow',
    inputSchema: IdentifyAndInterveneOnLearningAntiPatternsInputSchema,
    outputSchema: IdentifyAndInterveneOnLearningAntiPatternsOutputSchema,
  },
  async input => {
    const {output} = await identifyAndInterveneOnLearningAntiPatternsPrompt(input);
    return output!;
  }
);

export {
  identifyAndInterveneOnLearningAntiPatterns as identifyAndInterveneOnLearningAntiPatterns,
};
export type {
  IdentifyAndInterveneOnLearningAntiPatternsInput as IdentifyAndInterveneOnLearningAntiPatternsInput,
  IdentifyAndInterveneOnLearningAntiPatternsOutput as IdentifyAndInterveneOnLearningAntiPatternsOutput,
};





















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































